<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud OCR Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://rsms.me/inter/inter.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 flex items-center justify-center min-h-screen p-4;
        }
        .card {
            @apply bg-white shadow-lg rounded-2xl p-8 max-w-4xl w-full; /* Increased max-width */
        }
        .form-control {
            @apply block w-full px-4 py-2 text-base font-normal text-gray-700 bg-white bg-clip-padding border border-solid border-gray-300 rounded-xl transition ease-in-out m-0 focus:text-gray-700 focus:bg-white focus:border-blue-600 focus:outline-none;
        }
        .btn-primary {
            @apply inline-block px-6 py-2.5 bg-blue-600 text-white font-medium text-xs leading-tight uppercase rounded-xl shadow-md hover:bg-blue-700 hover:shadow-lg focus:bg-blue-700 focus:shadow-lg focus:outline-none focus:ring-0 active:bg-blue-800 active:shadow-lg transition duration-150 ease-in-out;
        }
        .btn-secondary {
            @apply inline-block px-6 py-2.5 bg-gray-600 text-white font-medium text-xs leading-tight uppercase rounded-xl shadow-md hover:bg-gray-700 hover:shadow-lg focus:bg-gray-700 focus:shadow-lg focus:outline-none focus:ring-0 active:bg-gray-800 active:shadow-lg transition duration-150 ease-in-out;
        }
        #loadingIndicator {
            @apply hidden mt-4 text-blue-600 font-semibold;
        }
        #messageBox {
            @apply hidden mt-4 p-3 rounded-xl;
        }
        .message-success {
            @apply bg-green-100 text-green-700;
        }
        .message-error {
            @apply bg-red-100 text-red-700;
        }
        .image-display-container {
            @apply flex flex-col md:flex-row gap-4 mt-6;
        }
        .image-wrapper {
            @apply flex-1 p-2 border border-gray-200 rounded-lg bg-gray-50 flex flex-col items-center justify-center;
        }
        .image-wrapper img {
            @apply max-w-full h-auto rounded-md;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Cloud OCR Converter</h1>

        <form id="uploadForm" class="space-y-6">
            <div>
                <label for="imageUpload" class="block text-gray-700 text-sm font-bold mb-2">
                    Upload Image:
                </label>
                <input type="file" id="imageUpload" accept="image/*" class="form-control" required>
            </div>
            
            <button type="submit" class="btn-primary w-full">Convert Image to Text</button>
        </form>

        <div id="loadingIndicator">Processing image... Please wait.</div>
        <div id="messageBox"></div>

        <div id="resultsSection" class="mt-8 hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">OCR Results</h2>
            <div class="image-display-container">
                <div class="image-wrapper">
                    <p class="text-gray-600 mb-2 font-semibold">Original Image:</p>
                    <img id="originalImagePreview" src="#" alt="Original Image" class="max-w-full h-auto rounded-lg">
                </div>
                <div class="image-wrapper">
                    <p class="text-gray-600 mb-2 font-semibold">Preprocessed Image:</p>
                    <img id="preprocessedImagePreview" src="#" alt="Preprocessed Image" class="max-w-full h-auto rounded-lg">
                </div>
            </div>

            <div class="mt-6">
                <label for="outputText" class="block text-gray-700 text-sm font-bold mb-2">
                    Extracted Text:
                </label>
                <textarea id="outputText" rows="10" class="form-control" placeholder="Extracted text will appear here..." readonly></textarea>
                <button id="copyButton" class="btn-secondary mt-4 w-full">Copy Text</button>
            </div>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const imageUpload = document.getElementById('imageUpload');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');
        const resultsSection = document.getElementById('resultsSection');
        const originalImagePreview = document.getElementById('originalImagePreview');
        const preprocessedImagePreview = document.getElementById('preprocessedImagePreview');
        const outputText = document.getElementById('outputText');
        const copyButton = document.getElementById('copyButton');

        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `mt-4 p-3 rounded-xl ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            messageBox.style.display = 'block';
        }

        function hideMessage() {
            messageBox.style.display = 'none';
            messageBox.textContent = '';
        }

        function resetResults() {
            resultsSection.classList.add('hidden');
            originalImagePreview.src = '#';
            preprocessedImagePreview.src = '#';
            outputText.value = '';
            hideMessage();
        }

        uploadForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            resetResults(); // Clear previous results
            loadingIndicator.style.display = 'block';

            const file = imageUpload.files[0];
            if (!file) {
                showMessage('Please select an image file.', 'error');
                loadingIndicator.style.display = 'none';
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            try {
                // Step 1: Upload image to Flask backend
                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });

                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json();
                    throw new Error(errorData.error || 'Failed to upload image.');
                }

                const uploadData = await uploadResponse.json();
                const jobId = uploadData.job_id;
                showMessage(`Upload successful. Processing initiated. Job ID: ${jobId}. Waiting for results...`, 'success');

                // Step 2: Poll for results
                let attempts = 0;
                const maxAttempts = 60; // Poll for up to 60 * 2 seconds = 2 minutes
                const pollInterval = 2000; // 2 seconds

                const pollPromise = new Promise((resolve, reject) => {
                    const intervalId = setInterval(async () => {
                        if (attempts >= maxAttempts) {
                            clearInterval(intervalId);
                            reject(new Error('Processing timed out. Please try again.'));
                            return;
                        }
                        attempts++;

                        try {
                            const resultsResponse = await fetch(`/results/${jobId}`);
                            if (!resultsResponse.ok) {
                                const errorData = await resultsResponse.json();
                                clearInterval(intervalId);
                                reject(new Error(errorData.error || 'Failed to fetch results.'));
                                return;
                            }
                            const resultsData = await resultsResponse.json();

                            if (resultsData.status === 'COMPLETED') {
                                clearInterval(intervalId);
                                resolve(resultsData);
                            } else if (resultsData.status === 'FAILED') {
                                clearInterval(intervalId);
                                reject(new Error(`Processing failed: ${resultsData.error_message || 'Unknown error.'}`));
                            }
                            // If status is PENDING, continue polling
                        } catch (pollError) {
                            clearInterval(intervalId);
                            reject(new Error(`Polling error: ${pollError.message}`));
                        }
                    }, pollInterval);
                });

                const finalResults = await pollPromise;

                loadingIndicator.style.display = 'none';
                resultsSection.classList.remove('hidden');
                originalImagePreview.src = finalResults.original_image_url;
                preprocessedImagePreview.src = finalResults.preprocessed_image_url;
                outputText.value = finalResults.extracted_text;
                showMessage('OCR results retrieved successfully!', 'success');

            } catch (error) {
                console.error('Overall Error:', error);
                loadingIndicator.style.display = 'none';
                showMessage(`Error: ${error.message}`, 'error');
                outputText.value = ''; // Clear output text on error
            }
        });

        copyButton.addEventListener('click', function() {
            outputText.select();
            outputText.setSelectionRange(0, 99999);
            try {
                // Use document.execCommand for wider compatibility in iframes
                const successful = document.execCommand('copy');
                if (successful) {
                    showMessage('Text copied to clipboard!', 'success');
                } else {
                    throw new Error('Failed to copy text.');
                }
            } catch (err) {
                console.error('Copy command failed:', err);
                showMessage('Failed to copy text. Please copy manually.', 'error');
            }
        });
    </script>
</body>
</html>
